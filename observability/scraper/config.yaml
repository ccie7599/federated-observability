apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-scraper-config
  namespace: observability
data:
  config.yaml: |
    receivers:
      # Prometheus receiver - scrapes metrics and forwards through pipeline
      prometheus:
        config:
          scrape_configs:
            - job_name: 'bert-inference'
              scrape_interval: 15s
              kubernetes_sd_configs:
                - role: endpoints
                  namespaces:
                    names:
                      - bert-inference
              relabel_configs:
                - source_labels: [__meta_kubernetes_service_name]
                  action: keep
                  regex: bert-inference
                - source_labels: [__meta_kubernetes_endpoint_port_name]
                  action: keep
                  regex: http
                - source_labels: [__meta_kubernetes_namespace]
                  target_label: namespace
                - source_labels: [__meta_kubernetes_pod_name]
                  target_label: pod
                - source_labels: [__meta_kubernetes_service_name]
                  target_label: service

            - job_name: 'dcgm-exporter'
              scrape_interval: 15s
              kubernetes_sd_configs:
                - role: endpoints
                  namespaces:
                    names:
                      - monitoring
              relabel_configs:
                - source_labels: [__meta_kubernetes_service_name]
                  action: keep
                  regex: dcgm-exporter
                - source_labels: [__meta_kubernetes_endpoint_port_name]
                  action: keep
                  regex: metrics
                - source_labels: [__meta_kubernetes_namespace]
                  target_label: namespace
                - source_labels: [__meta_kubernetes_pod_name]
                  target_label: pod

            - job_name: 'kubernetes-cadvisor'
              scrape_interval: 30s
              scheme: https
              kubernetes_sd_configs:
                - role: node
              tls_config:
                ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
                insecure_skip_verify: true
              bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
              relabel_configs:
                - action: labelmap
                  regex: __meta_kubernetes_node_label_(.+)
                - target_label: __address__
                  replacement: kubernetes.default.svc:443
                - source_labels: [__meta_kubernetes_node_name]
                  regex: (.+)
                  target_label: __metrics_path__
                  replacement: /api/v1/nodes/$1/proxy/metrics/cadvisor
                - source_labels: [__meta_kubernetes_node_name]
                  target_label: instance

            # Note: Apps should send telemetry via OTLP to otel-agent
            # Generic prometheus scraping removed in favor of OTLP-first approach
            # Specific services (bert-inference, dcgm-exporter) are scraped explicitly above

    processors:
      # Memory limiter
      memory_limiter:
        check_interval: 1s
        limit_mib: 400
        spike_limit_mib: 100

      # Batch for efficiency
      batch:
        send_batch_size: 1000
        send_batch_max_size: 1500
        timeout: 10s

    exporters:
      # Send to Prometheus
      prometheusremotewrite:
        endpoint: http://prometheus.monitoring:9090/api/v1/write
        resource_to_telemetry_conversion:
          enabled: true

    extensions:
      health_check:
        endpoint: 0.0.0.0:13133

    service:
      extensions: [health_check]
      telemetry:
        metrics:
          address: 0.0.0.0:8888
      pipelines:
        metrics:
          receivers: [prometheus]
          processors: [memory_limiter, batch]
          exporters: [prometheusremotewrite]
