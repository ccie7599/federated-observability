apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-scraper-config
  namespace: observability
data:
  config.yaml: |
    receivers:
      prometheus:
        config:
          scrape_configs:
            - job_name: 'bert-inference'
              scrape_interval: 15s
              kubernetes_sd_configs:
                - role: endpoints
                  namespaces:
                    names:
                      - bert-inference
              relabel_configs:
                - source_labels: [__meta_kubernetes_service_name]
                  action: keep
                  regex: bert-inference
                - source_labels: [__meta_kubernetes_endpoint_port_name]
                  action: keep
                  regex: http
                - source_labels: [__meta_kubernetes_namespace]
                  target_label: namespace
                - source_labels: [__meta_kubernetes_pod_name]
                  target_label: pod
                - source_labels: [__meta_kubernetes_service_name]
                  target_label: service

            - job_name: 'dcgm-exporter'
              scrape_interval: 15s
              kubernetes_sd_configs:
                - role: endpoints
                  namespaces:
                    names:
                      - monitoring
              relabel_configs:
                - source_labels: [__meta_kubernetes_service_name]
                  action: keep
                  regex: dcgm-exporter
                - source_labels: [__meta_kubernetes_endpoint_port_name]
                  action: keep
                  regex: metrics
                - source_labels: [__meta_kubernetes_namespace]
                  target_label: namespace
                - source_labels: [__meta_kubernetes_pod_name]
                  target_label: pod

            - job_name: 'kube-state-metrics'
              scrape_interval: 30s
              kubernetes_sd_configs:
                - role: endpoints
                  namespaces:
                    names:
                      - observability
              relabel_configs:
                - source_labels: [__meta_kubernetes_service_name]
                  action: keep
                  regex: kube-state-metrics
                - source_labels: [__meta_kubernetes_endpoint_port_name]
                  action: keep
                  regex: http-metrics
                - source_labels: [__meta_kubernetes_namespace]
                  target_label: namespace
                - source_labels: [__meta_kubernetes_pod_name]
                  target_label: pod

    processors:
      resource:
        attributes:
          - key: cluster.id
            value: fed-observability-test
            action: insert
          - key: cluster.role
            value: hub
            action: insert

      memory_limiter:
        check_interval: 1s
        limit_mib: 400
        spike_limit_mib: 100

      batch:
        send_batch_size: 1000
        send_batch_max_size: 1500
        timeout: 10s

    exporters:
      otlp/gateway:
        endpoint: otel-gateway.observability-hub.svc.cluster.local:4317
        tls:
          cert_file: /certs/tls.crt
          key_file: /certs/tls.key
          ca_file: /certs/ca.crt

    extensions:
      health_check:
        endpoint: 0.0.0.0:13133

    service:
      extensions: [health_check]
      telemetry:
        metrics:
          address: 0.0.0.0:8888
      pipelines:
        metrics:
          receivers: [prometheus]
          processors: [memory_limiter, resource, batch]
          exporters: [otlp/gateway]
