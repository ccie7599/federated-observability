apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-aggregator-config
  namespace: observability
data:
  config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317

    processors:
      memory_limiter:
        check_interval: 1s
        limit_mib: 1800
        spike_limit_mib: 400

      transform:
        error_mode: ignore
        log_statements:
          - context: log
            statements:
              - replace_pattern(body, "\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}\\b", "[EMAIL_REDACTED]")
              - replace_pattern(body, "\\b\\d{3}-\\d{2}-\\d{4}\\b", "[SSN_REDACTED]")
              - replace_pattern(body, "\\b\\d{4}[- ]?\\d{4}[- ]?\\d{4}[- ]?\\d{4}\\b", "[CC_REDACTED]")
              - replace_pattern(body, "\\b\\d{3}[-.\\s]?\\d{3}[-.\\s]?\\d{4}\\b", "[PHONE_REDACTED]")
        trace_statements:
          - context: span
            statements:
              - replace_pattern(attributes["http.url"], "password=[^&]*", "password=[REDACTED]")
              - replace_pattern(attributes["http.url"], "token=[^&]*", "token=[REDACTED]")
              - replace_pattern(attributes["http.url"], "api_key=[^&]*", "api_key=[REDACTED]")
              - delete_key(attributes, "user.email") where attributes["user.email"] != nil
              - delete_key(attributes, "user.ssn") where attributes["user.ssn"] != nil

      attributes:
        actions:
          - key: db.statement
            action: hash
          - key: http.request.header.authorization
            action: delete
          - key: http.request.header.cookie
            action: delete
          - key: http.request.header.x-api-key
            action: delete

      filter:
        error_mode: ignore
        logs:
          log_record:
            - 'severity_number < SEVERITY_NUMBER_INFO'
            - 'IsMatch(body, "healthcheck")'
            - 'IsMatch(body, "readiness")'
            - 'IsMatch(body, "liveness")'
        traces:
          span:
            - 'name == "health"'
            - 'name == "ready"'
            - 'name == "live"'

      tail_sampling:
        decision_wait: 10s
        num_traces: 100000
        policies:
          - name: errors-always
            type: status_code
            status_code:
              status_codes: [ERROR]
          - name: slow-traces
            type: latency
            latency:
              threshold_ms: 1000
          - name: high-value-services
            type: string_attribute
            string_attribute:
              key: service.name
              values: [payment-service, auth-service, transaction-service]
          - name: probabilistic-sample
            type: probabilistic
            probabilistic:
              sampling_percentage: 10

      metricstransform:
        transforms:
          - include: ^http_server_request_duration.*
            match_type: regexp
            action: update
            operations:
              - action: aggregate_labels
                aggregation_type: sum
                label_set: [http_method, http_status_code, service_name]

      batch:
        send_batch_size: 5000
        send_batch_max_size: 10000
        timeout: 30s

    exporters:
      otlphttp:
        endpoint: https://hub.observability.example.com:443
        compression: zstd
        tls:
          cert_file: /certs/client.crt
          key_file: /certs/client.key
          ca_file: /certs/ca.crt
        headers:
          X-Cluster-ID: ${env:CLUSTER_ID}
          X-Environment: ${env:ENVIRONMENT}
        retry_on_failure:
          enabled: true
          initial_interval: 5s
          max_interval: 60s
          max_elapsed_time: 300s
        sending_queue:
          enabled: true
          num_consumers: 10
          queue_size: 10000
          storage: file_storage

    extensions:
      health_check:
        endpoint: 0.0.0.0:13133
      file_storage:
        directory: /var/otel/queue
        timeout: 10s
        compaction:
          on_start: true
          on_rebound: true
          directory: /var/otel/queue/compaction

    service:
      extensions: [health_check, file_storage]
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, transform, attributes, filter, tail_sampling, batch]
          exporters: [otlphttp]
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, transform, attributes, filter, metricstransform, batch]
          exporters: [otlphttp]
        logs:
          receivers: [otlp]
          processors: [memory_limiter, transform, attributes, filter, batch]
          exporters: [otlphttp]
