apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-router-splunk-config
  namespace: observability-hub
data:
  config.yaml: |
    receivers:
      kafka:
        brokers:
          - redpanda-0.redpanda.observability-hub.svc.cluster.local:9093
          - redpanda-1.redpanda.observability-hub.svc.cluster.local:9093
          - redpanda-2.redpanda.observability-hub.svc.cluster.local:9093
        topic: otlp.logs
        encoding: otlp_proto
        group_id: router-splunk-logs
        auth:
          tls:
            cert_file: /certs/kafka-client.crt
            key_file: /certs/kafka-client.key
            ca_file: /certs/kafka-ca.crt

    processors:
      memory_limiter:
        check_interval: 1s
        limit_mib: 1500
        spike_limit_mib: 300

      transform:
        log_statements:
          - context: log
            statements:
              - set(attributes["index"], "main") where attributes["index"] == nil
              - set(attributes["sourcetype"], Concat(["otel:", resource.attributes["service.name"]], ""))

      batch:
        send_batch_size: 8000
        timeout: 10s

    exporters:
      splunk_hec:
        endpoint: https://splunk-hec.customer.example.com:8088
        token: ${env:SPLUNK_HEC_TOKEN}
        source: otel
        sourcetype: otel
        index: main
        tls:
          ca_file: /certs/splunk-ca.crt
        retry_on_failure:
          enabled: true
          initial_interval: 10s
          max_interval: 60s
        sending_queue:
          enabled: true
          queue_size: 5000
          storage: file_storage

    extensions:
      health_check:
        endpoint: 0.0.0.0:13133
      file_storage:
        directory: /var/otel/queue

    service:
      extensions: [health_check, file_storage]
      pipelines:
        logs:
          receivers: [kafka]
          processors: [memory_limiter, transform, batch]
          exporters: [splunk_hec]
