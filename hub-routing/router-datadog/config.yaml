apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-router-datadog-config
  namespace: observability-hub
data:
  config.yaml: |
    receivers:
      kafka/metrics:
        brokers:
          - redpanda-0.redpanda.observability-hub.svc.cluster.local:9093
          - redpanda-1.redpanda.observability-hub.svc.cluster.local:9093
          - redpanda-2.redpanda.observability-hub.svc.cluster.local:9093
        topic: otlp.metrics
        encoding: otlp_proto
        group_id: router-datadog-metrics
        auth:
          tls:
            cert_file: /certs/kafka-client.crt
            key_file: /certs/kafka-client.key
            ca_file: /certs/kafka-ca.crt

      kafka/traces:
        brokers:
          - redpanda-0.redpanda.observability-hub.svc.cluster.local:9093
          - redpanda-1.redpanda.observability-hub.svc.cluster.local:9093
          - redpanda-2.redpanda.observability-hub.svc.cluster.local:9093
        topic: otlp.traces
        encoding: otlp_proto
        group_id: router-datadog-traces
        auth:
          tls:
            cert_file: /certs/kafka-client.crt
            key_file: /certs/kafka-client.key
            ca_file: /certs/kafka-ca.crt

    processors:
      memory_limiter:
        check_interval: 1s
        limit_mib: 2000
        spike_limit_mib: 500

      batch:
        send_batch_size: 5000
        timeout: 10s

    exporters:
      datadog:
        api:
          key: ${env:DD_API_KEY}
          site: datadoghq.com
        traces:
          span_name_as_resource_name: true
        metrics:
          resource_attributes_as_tags: true
        retry_on_failure:
          enabled: true
          initial_interval: 10s
          max_interval: 60s
        sending_queue:
          enabled: true
          queue_size: 5000
          storage: file_storage

    extensions:
      health_check:
        endpoint: 0.0.0.0:13133
      file_storage:
        directory: /var/otel/queue

    service:
      extensions: [health_check, file_storage]
      pipelines:
        traces:
          receivers: [kafka/traces]
          processors: [memory_limiter, batch]
          exporters: [datadog]
        metrics:
          receivers: [kafka/metrics]
          processors: [memory_limiter, batch]
          exporters: [datadog]
