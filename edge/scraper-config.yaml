apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-scraper-config
  namespace: observability
data:
  config.yaml: |
    receivers:
      prometheus:
        config:
          scrape_configs:
            - job_name: 'bert-inference'
              scrape_interval: 15s
              kubernetes_sd_configs:
                - role: endpoints
                  namespaces:
                    names:
                      - bert-inference
              relabel_configs:
                - source_labels: [__meta_kubernetes_service_name]
                  action: keep
                  regex: bert-inference
                - source_labels: [__meta_kubernetes_endpoint_port_name]
                  action: keep
                  regex: http
                - source_labels: [__meta_kubernetes_namespace]
                  target_label: namespace
                - source_labels: [__meta_kubernetes_pod_name]
                  target_label: pod
                - source_labels: [__meta_kubernetes_service_name]
                  target_label: service

            - job_name: 'dcgm-exporter'
              scrape_interval: 15s
              kubernetes_sd_configs:
                - role: endpoints
                  namespaces:
                    names:
                      - observability
              relabel_configs:
                - source_labels: [__meta_kubernetes_service_name]
                  action: keep
                  regex: dcgm-exporter
                - source_labels: [__meta_kubernetes_endpoint_port_name]
                  action: keep
                  regex: metrics
                - source_labels: [__meta_kubernetes_namespace]
                  target_label: namespace
                - source_labels: [__meta_kubernetes_pod_name]
                  target_label: pod

            - job_name: 'kube-state-metrics'
              scrape_interval: 30s
              kubernetes_sd_configs:
                - role: endpoints
                  namespaces:
                    names:
                      - observability
              relabel_configs:
                - source_labels: [__meta_kubernetes_service_name]
                  action: keep
                  regex: kube-state-metrics
                - source_labels: [__meta_kubernetes_endpoint_port_name]
                  action: keep
                  regex: http-metrics
                - source_labels: [__meta_kubernetes_namespace]
                  target_label: namespace
                - source_labels: [__meta_kubernetes_pod_name]
                  target_label: pod

            - job_name: 'kubernetes-cadvisor'
              scrape_interval: 30s
              scheme: https
              kubernetes_sd_configs:
                - role: node
              tls_config:
                ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
                insecure_skip_verify: true
              bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
              relabel_configs:
                - action: labelmap
                  regex: __meta_kubernetes_node_label_(.+)
                - target_label: __address__
                  replacement: kubernetes.default.svc:443
                - source_labels: [__meta_kubernetes_node_name]
                  regex: (.+)
                  target_label: __metrics_path__
                  replacement: /api/v1/nodes/$1/proxy/metrics/cadvisor
                - source_labels: [__meta_kubernetes_node_name]
                  target_label: instance

    processors:
      resource:
        attributes:
          - key: cluster.id
            value: fed-observability-remote
            action: insert
          - key: cluster.role
            value: edge
            action: insert

      memory_limiter:
        check_interval: 1s
        limit_mib: 400
        spike_limit_mib: 100

      batch:
        send_batch_size: 1000
        send_batch_max_size: 1500
        timeout: 10s

    exporters:
      otlp/hub:
        endpoint: 172.238.181.107:4317
        tls:
          cert_file: /certs/tls.crt
          key_file: /certs/tls.key
          ca_file: /certs/ca.crt
        retry_on_failure:
          enabled: true
          initial_interval: 5s
          max_interval: 60s

    extensions:
      health_check:
        endpoint: 0.0.0.0:13133

    service:
      extensions: [health_check]
      telemetry:
        metrics:
          address: 0.0.0.0:8888
      pipelines:
        metrics:
          receivers: [prometheus]
          processors: [memory_limiter, resource, batch]
          exporters: [otlp/hub]
