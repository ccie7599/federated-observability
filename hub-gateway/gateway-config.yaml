apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-gateway-config
  namespace: observability-hub
data:
  config.yaml: |
    receivers:
      otlp:
        protocols:
          http:
            endpoint: 0.0.0.0:4318
            cors:
              allowed_origins: []
              allowed_headers: ["X-Cluster-ID", "X-Environment"]

    processors:
      memory_limiter:
        check_interval: 1s
        limit_mib: 3500
        spike_limit_mib: 800

      resource:
        attributes:
          - key: hub.received_at
            value: ${env:HOSTNAME}
            action: insert
          - key: hub.region
            value: ${env:HUB_REGION}
            action: insert

      filter:
        error_mode: ignore
        traces:
          span:
            - 'attributes["service.name"] == nil'
        metrics:
          metric:
            - 'resource.attributes["service.name"] == nil'

      batch:
        send_batch_size: 10000
        timeout: 5s

    exporters:
      kafka/metrics:
        brokers:
          - redpanda-0.redpanda.observability-hub.svc.cluster.local:9093
          - redpanda-1.redpanda.observability-hub.svc.cluster.local:9093
          - redpanda-2.redpanda.observability-hub.svc.cluster.local:9093
        topic: otlp.metrics
        encoding: otlp_proto
        producer:
          compression: zstd
          max_message_bytes: 10000000
          required_acks: -1
        auth:
          tls:
            cert_file: /certs/kafka-client.crt
            key_file: /certs/kafka-client.key
            ca_file: /certs/kafka-ca.crt

      kafka/logs:
        brokers:
          - redpanda-0.redpanda.observability-hub.svc.cluster.local:9093
          - redpanda-1.redpanda.observability-hub.svc.cluster.local:9093
          - redpanda-2.redpanda.observability-hub.svc.cluster.local:9093
        topic: otlp.logs
        encoding: otlp_proto
        producer:
          compression: zstd
          max_message_bytes: 10000000
          required_acks: -1
        auth:
          tls:
            cert_file: /certs/kafka-client.crt
            key_file: /certs/kafka-client.key
            ca_file: /certs/kafka-ca.crt

      kafka/traces:
        brokers:
          - redpanda-0.redpanda.observability-hub.svc.cluster.local:9093
          - redpanda-1.redpanda.observability-hub.svc.cluster.local:9093
          - redpanda-2.redpanda.observability-hub.svc.cluster.local:9093
        topic: otlp.traces
        encoding: otlp_proto
        producer:
          compression: zstd
          max_message_bytes: 10000000
          required_acks: -1
        auth:
          tls:
            cert_file: /certs/kafka-client.crt
            key_file: /certs/kafka-client.key
            ca_file: /certs/kafka-ca.crt

    extensions:
      health_check:
        endpoint: 0.0.0.0:13133
      zpages:
        endpoint: 0.0.0.0:55679

    service:
      extensions: [health_check, zpages]
      telemetry:
        metrics:
          address: 0.0.0.0:8888
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, resource, filter, batch]
          exporters: [kafka/traces]
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, resource, filter, batch]
          exporters: [kafka/metrics]
        logs:
          receivers: [otlp]
          processors: [memory_limiter, resource, filter, batch]
          exporters: [kafka/logs]
