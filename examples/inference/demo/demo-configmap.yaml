apiVersion: v1
kind: ConfigMap
metadata:
  name: demo-html
  namespace: bert-inference
data:
  index.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>BERT Inference Demo</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <style>
            :root {
                --bg-primary: #0d1117;
                --bg-secondary: #161b22;
                --bg-tertiary: #21262d;
                --border-color: #30363d;
                --text-primary: #e6edf3;
                --text-secondary: #8b949e;
                --accent-blue: #58a6ff;
                --accent-green: #3fb950;
                --accent-purple: #a371f7;
                --accent-orange: #d29922;
                --accent-red: #f85149;
                --gradient-start: #58a6ff;
                --gradient-end: #a371f7;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
                background: var(--bg-primary);
                color: var(--text-primary);
                min-height: 100vh;
                line-height: 1.5;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 2rem;
            }

            header {
                text-align: center;
                margin-bottom: 1.5rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid var(--border-color);
            }

            h1 {
                font-size: 2.5rem;
                font-weight: 600;
                background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                margin-bottom: 0.5rem;
            }

            .subtitle {
                color: var(--text-secondary);
                font-size: 1.1rem;
            }

            .gpu-badge {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.25rem 0.75rem;
                background: linear-gradient(135deg, #76b900, #3fb950);
                color: white;
                border-radius: 4px;
                font-size: 0.75rem;
                font-weight: 600;
                margin-left: 1rem;
            }

            /* Tabs */
            .tabs {
                display: flex;
                gap: 0.5rem;
                margin-bottom: 1.5rem;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 0;
            }

            .tab {
                padding: 0.75rem 1.5rem;
                background: transparent;
                border: none;
                color: var(--text-secondary);
                font-size: 1rem;
                font-weight: 500;
                cursor: pointer;
                border-bottom: 2px solid transparent;
                margin-bottom: -1px;
                transition: all 0.2s;
            }

            .tab:hover {
                color: var(--text-primary);
            }

            .tab.active {
                color: var(--accent-blue);
                border-bottom-color: var(--accent-blue);
            }

            .tab-icon {
                margin-right: 0.5rem;
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            /* Map styles */
            #map {
                height: 500px;
                width: 100%;
                border-radius: 12px;
                border: 1px solid var(--border-color);
            }

            .map-container {
                background: var(--bg-secondary);
                border-radius: 12px;
                padding: 1.5rem;
                border: 1px solid var(--border-color);
            }

            .map-info {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1rem;
                margin-top: 1.5rem;
            }

            .location-card {
                background: var(--bg-tertiary);
                border-radius: 8px;
                padding: 1rem;
                border-left: 4px solid var(--accent-blue);
            }

            .location-card.server {
                border-left-color: var(--accent-green);
            }

            .location-card.edge {
                border-left-color: var(--accent-purple);
            }

            .location-label {
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: var(--text-secondary);
                margin-bottom: 0.25rem;
            }

            .location-name {
                font-size: 1.25rem;
                font-weight: 600;
                margin-bottom: 0.5rem;
            }

            .location-name.user { color: var(--accent-blue); }
            .location-name.server { color: var(--accent-green); }

            .location-detail {
                font-size: 0.875rem;
                color: var(--text-secondary);
            }

            .distance-badge {
                display: inline-block;
                padding: 0.5rem 1rem;
                background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
                color: white;
                border-radius: 20px;
                font-weight: 600;
                margin-top: 0.5rem;
            }

            .edge-advantage {
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                padding: 1.5rem;
                margin-top: 1.5rem;
                text-align: center;
            }

            .advantage-title {
                font-size: 1.25rem;
                font-weight: 600;
                margin-bottom: 1rem;
                color: var(--accent-green);
            }

            .advantage-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 1.5rem;
                margin-top: 1rem;
            }

            .advantage-item {
                text-align: center;
            }

            .advantage-value {
                font-size: 2rem;
                font-weight: 700;
                color: var(--accent-green);
            }

            .advantage-label {
                font-size: 0.875rem;
                color: var(--text-secondary);
            }

            /* Custom Leaflet markers */
            .custom-marker {
                background: none;
                border: none;
            }

            .marker-pin {
                width: 30px;
                height: 30px;
                border-radius: 50% 50% 50% 0;
                position: absolute;
                transform: rotate(-45deg);
                left: 50%;
                top: 50%;
                margin: -15px 0 0 -15px;
                animation: pulse-marker 2s infinite;
            }

            .marker-pin.user {
                background: linear-gradient(135deg, #58a6ff, #1f6feb);
                box-shadow: 0 0 20px rgba(88, 166, 255, 0.5);
            }

            .marker-pin.server {
                background: linear-gradient(135deg, #3fb950, #238636);
                box-shadow: 0 0 20px rgba(63, 185, 80, 0.5);
            }

            .marker-pin::after {
                content: '';
                width: 14px;
                height: 14px;
                margin: 8px 0 0 8px;
                background: rgba(255,255,255,0.9);
                position: absolute;
                border-radius: 50%;
            }

            @keyframes pulse-marker {
                0%, 100% { box-shadow: 0 0 20px rgba(88, 166, 255, 0.5); }
                50% { box-shadow: 0 0 35px rgba(88, 166, 255, 0.8); }
            }

            .marker-label {
                position: absolute;
                white-space: nowrap;
                left: 35px;
                top: -5px;
                background: var(--bg-secondary);
                padding: 0.5rem 0.75rem;
                border-radius: 6px;
                font-size: 0.8rem;
                font-weight: 600;
                border: 1px solid var(--border-color);
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }

            .marker-label.user {
                color: var(--accent-blue);
            }

            .marker-label.server {
                color: var(--accent-green);
            }

            .marker-label .latency {
                display: block;
                font-size: 0.7rem;
                color: var(--text-secondary);
                font-weight: 400;
            }

            /* Demo tab styles (existing) */
            .config-panel {
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .config-row {
                display: flex;
                gap: 1rem;
                align-items: center;
                flex-wrap: wrap;
            }

            .input-group {
                flex: 1;
                min-width: 150px;
                max-width: 200px;
            }

            label {
                display: block;
                color: var(--text-secondary);
                font-size: 0.875rem;
                margin-bottom: 0.5rem;
                font-weight: 500;
            }

            input[type="text"], input[type="number"] {
                width: 100%;
                padding: 0.75rem 1rem;
                background: var(--bg-tertiary);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                color: var(--text-primary);
                font-size: 1rem;
                transition: border-color 0.2s, box-shadow 0.2s;
            }

            input[type="text"]:focus, input[type="number"]:focus {
                outline: none;
                border-color: var(--accent-blue);
                box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
            }

            .btn {
                padding: 0.75rem 1.5rem;
                border: none;
                border-radius: 8px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
            }

            .btn-primary {
                background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
                color: white;
            }

            .btn-primary:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(88, 166, 255, 0.3);
            }

            .btn-secondary {
                background: var(--bg-tertiary);
                color: var(--text-primary);
                border: 1px solid var(--border-color);
            }

            .btn-secondary:hover {
                background: var(--border-color);
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .stat-card {
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                padding: 1.25rem;
                text-align: center;
            }

            .stat-value {
                font-size: 2rem;
                font-weight: 700;
                margin-bottom: 0.25rem;
            }

            .stat-label {
                color: var(--text-secondary);
                font-size: 0.875rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .stat-value.http { color: var(--accent-blue); }
            .stat-value.server { color: var(--accent-purple); }
            .stat-value.success { color: var(--accent-green); }
            .stat-value.error { color: var(--accent-red); }
            .stat-value.rps { color: var(--accent-orange); }

            .main-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1.5rem;
            }

            @media (max-width: 1024px) {
                .main-grid {
                    grid-template-columns: 1fr;
                }
                .advantage-grid {
                    grid-template-columns: 1fr;
                }
            }

            .panel {
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                overflow: hidden;
            }

            .panel-header {
                padding: 1rem 1.25rem;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .panel-title {
                font-size: 1rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .panel-body {
                padding: 1.25rem;
            }

            .chart-container {
                position: relative;
                height: 300px;
            }

            .query-log {
                height: 300px;
                overflow-y: auto;
                font-family: 'SF Mono', 'Fira Code', monospace;
                font-size: 0.8rem;
            }

            .log-entry {
                padding: 0.75rem;
                border-bottom: 1px solid var(--border-color);
                display: grid;
                grid-template-columns: auto 1fr auto auto;
                gap: 1rem;
                align-items: center;
            }

            .log-entry:last-child {
                border-bottom: none;
            }

            .log-time {
                color: var(--text-secondary);
                font-size: 0.75rem;
            }

            .log-text {
                color: var(--text-primary);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .log-latency {
                display: flex;
                gap: 0.75rem;
            }

            .latency-badge {
                padding: 0.25rem 0.5rem;
                border-radius: 4px;
                font-size: 0.75rem;
                font-weight: 600;
            }

            .latency-badge.http {
                background: rgba(88, 166, 255, 0.15);
                color: var(--accent-blue);
            }

            .latency-badge.server {
                background: rgba(163, 113, 247, 0.15);
                color: var(--accent-purple);
            }

            .status-indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--accent-green);
            }

            .status-indicator.error {
                background: var(--accent-red);
            }

            .sample-queries {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                margin-top: 1rem;
            }

            .sample-query {
                padding: 0.5rem 0.75rem;
                background: var(--bg-tertiary);
                border: 1px solid var(--border-color);
                border-radius: 6px;
                font-size: 0.8rem;
                color: var(--text-secondary);
                cursor: pointer;
                transition: all 0.2s;
            }

            .sample-query:hover {
                border-color: var(--accent-blue);
                color: var(--text-primary);
            }

            .connection-status {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-size: 0.875rem;
                font-weight: 500;
            }

            .connection-status.connected {
                background: rgba(63, 185, 80, 0.15);
                color: var(--accent-green);
            }

            .connection-status.disconnected {
                background: rgba(248, 81, 73, 0.15);
                color: var(--accent-red);
            }

            .controls {
                display: flex;
                gap: 0.75rem;
                flex-wrap: wrap;
                align-items: center;
            }

            .checkbox-group {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            input[type="checkbox"] {
                width: 18px;
                height: 18px;
                accent-color: var(--accent-blue);
            }

            .legend {
                display: flex;
                justify-content: center;
                gap: 2rem;
                margin-top: 1rem;
            }

            .legend-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.875rem;
                color: var(--text-secondary);
            }

            .legend-color {
                width: 12px;
                height: 12px;
                border-radius: 3px;
            }

            .legend-color.http { background: var(--accent-blue); }
            .legend-color.server { background: var(--accent-purple); }

            /* Leaflet dark theme overrides */
            .leaflet-container {
                background: var(--bg-primary);
            }
            .leaflet-control-zoom a {
                background: var(--bg-secondary) !important;
                color: var(--text-primary) !important;
                border-color: var(--border-color) !important;
            }
            .leaflet-control-zoom a:hover {
                background: var(--bg-tertiary) !important;
            }
            .leaflet-control-attribution {
                background: rgba(13, 17, 23, 0.8) !important;
                color: var(--text-secondary) !important;
            }
            .leaflet-control-attribution a {
                color: var(--accent-blue) !important;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>Edge Inference Demo <span class="gpu-badge">GPU Accelerated</span></h1>
                <p class="subtitle">Distributed Model Inference on Linode Kubernetes Engine</p>
            </header>

            <div class="tabs">
                <button class="tab active" data-tab="demo">
                    <span class="tab-icon">&#9889;</span>Live Demo
                </button>
                <button class="tab" data-tab="map">
                    <span class="tab-icon">&#127758;</span>Edge Map
                </button>
            </div>

            <!-- Map Tab -->
            <div class="tab-content" id="map-tab">
                <div class="map-container">
                    <div id="map"></div>
                    <div class="map-info">
                        <div class="location-card">
                            <div class="location-label">Your Location</div>
                            <div class="location-name user" id="userLocationName">Detecting...</div>
                            <div class="location-detail" id="userLocationDetail">Requesting geolocation...</div>
                        </div>
                        <div class="location-card server">
                            <div class="location-label">Edge Server</div>
                            <div class="location-name server">Chicago, IL</div>
                            <div class="location-detail">Linode LKE · us-ord · RTX 4000 GPU</div>
                        </div>
                        <div class="location-card edge">
                            <div class="location-label">Network Distance</div>
                            <div class="location-name" style="color: var(--accent-purple);" id="distanceValue">Calculating...</div>
                            <div class="location-detail" id="distanceDetail">Estimated latency advantage</div>
                        </div>
                    </div>
                </div>

                <div class="edge-advantage">
                    <div class="advantage-title">&#9889; Edge Deployment Advantage</div>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        Distributed edge inference reduces latency by placing GPU compute closer to end users
                    </p>
                    <div class="advantage-grid">
                        <div class="advantage-item">
                            <div class="advantage-value" id="edgeLatency">~20ms</div>
                            <div class="advantage-label">Edge Latency (Chicago)</div>
                        </div>
                        <div class="advantage-item">
                            <div class="advantage-value" style="color: var(--accent-orange);" id="centralLatency">~80ms</div>
                            <div class="advantage-label">Centralized (Virginia)</div>
                        </div>
                        <div class="advantage-item">
                            <div class="advantage-value" style="color: var(--accent-blue);" id="improvement">4x faster</div>
                            <div class="advantage-label">Improvement</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Demo Tab -->
            <div class="tab-content active" id="demo-tab">
                <div class="config-panel">
                    <div class="config-row">
                        <div class="input-group">
                            <label for="interval">Auto Interval (ms)</label>
                            <input type="number" id="interval" value="1000" min="100" max="10000" step="100">
                        </div>
                        <div class="controls">
                            <div class="checkbox-group">
                                <input type="checkbox" id="autoQuery">
                                <label for="autoQuery" style="margin: 0;">Auto-generate queries</label>
                            </div>
                            <button class="btn btn-primary" id="sendQuery">Send Query</button>
                            <button class="btn btn-secondary" id="clearStats">Clear Stats</button>
                            <span class="connection-status connected" id="connectionStatus">
                                <span class="status-indicator"></span>
                                Connected
                            </span>
                        </div>
                    </div>
                    <div class="sample-queries">
                        <span style="color: var(--text-secondary); font-size: 0.8rem; margin-right: 0.5rem;">Try:</span>
                        <span class="sample-query" data-text="The quick brown fox jumps over the lazy dog.">Quick brown fox</span>
                        <span class="sample-query" data-text="Machine learning models can process natural language with remarkable accuracy.">ML models</span>
                        <span class="sample-query" data-text="Kubernetes orchestrates containerized applications at scale.">Kubernetes</span>
                        <span class="sample-query" data-text="GPU acceleration improves deep learning inference performance.">GPU inference</span>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value http" id="avgHttpLatency">--</div>
                        <div class="stat-label">Avg HTTP Latency</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value server" id="avgServerLatency">--</div>
                        <div class="stat-label">Avg Server Latency</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value success" id="successCount">0</div>
                        <div class="stat-label">Successful</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value error" id="errorCount">0</div>
                        <div class="stat-label">Errors</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value rps" id="rps">0.0</div>
                        <div class="stat-label">Requests/sec</div>
                    </div>
                </div>

                <div class="main-grid">
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title">
                                <span style="color: var(--accent-blue);">&#9632;</span>
                                Latency Over Time (Last 60s)
                            </span>
                        </div>
                        <div class="panel-body">
                            <div class="chart-container">
                                <canvas id="latencyChart"></canvas>
                            </div>
                            <div class="legend">
                                <div class="legend-item">
                                    <div class="legend-color http"></div>
                                    <span>HTTP Round-Trip</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color server"></div>
                                    <span>Server Processing</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title">
                                <span style="color: var(--accent-green);">&#9632;</span>
                                Query Log
                            </span>
                            <span style="color: var(--text-secondary); font-size: 0.8rem;" id="logCount">0 queries</span>
                        </div>
                        <div class="panel-body" style="padding: 0;">
                            <div class="query-log" id="queryLog">
                                <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                                    No queries yet. Click "Send Query" or enable auto-generate.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Server location (Chicago)
            const serverLocation = { lat: 41.8781, lng: -87.6298, name: 'Chicago, IL', region: 'us-ord' };

            // Simulated centralized location (Virginia)
            const centralizedLocation = { lat: 38.9072, lng: -77.0369, name: 'N. Virginia' };

            let userLocation = null;
            let map = null;
            let userMarker = null;
            let serverMarker = null;
            let connectionLine = null;

            // Initialize map
            function initMap() {
                map = L.map('map', {
                    center: [39.8283, -98.5795], // Center of US
                    zoom: 4,
                    zoomControl: true
                });

                // Dark theme tiles (CartoDB Dark Matter)
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(map);

                // Add server marker
                addServerMarker();

                // Get user location
                getUserLocation();
            }

            function createCustomIcon(type) {
                return L.divIcon({
                    className: 'custom-marker',
                    html: `
                        <div class="marker-pin ${type}"></div>
                        <div class="marker-label ${type}">
                            ${type === 'user' ? '<span id="markerUserName">You</span>' : 'Edge Server'}<br>
                            <span class="latency">${type === 'user' ? '<span id="markerUserLatency">Detecting...</span>' : 'Chicago · ~8ms inference'}</span>
                        </div>
                    `,
                    iconSize: [30, 42],
                    iconAnchor: [15, 42]
                });
            }

            function addServerMarker() {
                serverMarker = L.marker([serverLocation.lat, serverLocation.lng], {
                    icon: createCustomIcon('server')
                }).addTo(map);
            }

            function addUserMarker(lat, lng) {
                if (userMarker) {
                    map.removeLayer(userMarker);
                }
                userMarker = L.marker([lat, lng], {
                    icon: createCustomIcon('user')
                }).addTo(map);
            }

            function drawConnectionLine() {
                if (connectionLine) {
                    map.removeLayer(connectionLine);
                }
                if (userLocation) {
                    connectionLine = L.polyline([
                        [userLocation.lat, userLocation.lng],
                        [serverLocation.lat, serverLocation.lng]
                    ], {
                        color: '#58a6ff',
                        weight: 2,
                        opacity: 0.6,
                        dashArray: '10, 10'
                    }).addTo(map);
                }
            }

            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 3959; // Earth's radius in miles
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                          Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            function estimateLatency(distanceMiles) {
                // Rough estimate: ~1ms per 60 miles (accounting for fiber, routing, etc.)
                return Math.round(distanceMiles / 60) + 5; // +5ms for processing overhead
            }

            async function getUserLocation() {
                if ('geolocation' in navigator) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                enableHighAccuracy: false,
                                timeout: 10000
                            });
                        });

                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        // Reverse geocode to get city name
                        try {
                            const response = await fetch(
                                `https://nominatim.openstreetmap.org/reverse?lat=${userLocation.lat}&lon=${userLocation.lng}&format=json`
                            );
                            const data = await response.json();
                            const city = data.address.city || data.address.town || data.address.village || 'Unknown';
                            const state = data.address.state || '';
                            userLocation.name = `${city}, ${state}`;
                        } catch (e) {
                            userLocation.name = 'Your Location';
                        }

                        updateMapWithUserLocation();
                    } catch (error) {
                        console.log('Geolocation error:', error);
                        // Default to a location (Detroit area based on user mention of Michigan)
                        userLocation = { lat: 42.3314, lng: -83.0458, name: 'Detroit, MI (estimated)' };
                        updateMapWithUserLocation();
                    }
                } else {
                    userLocation = { lat: 42.3314, lng: -83.0458, name: 'Detroit, MI (estimated)' };
                    updateMapWithUserLocation();
                }
            }

            function updateMapWithUserLocation() {
                // Add user marker
                addUserMarker(userLocation.lat, userLocation.lng);

                // Draw connection line
                drawConnectionLine();

                // Fit bounds to show both markers
                const bounds = L.latentBounds ? L.latentBounds([
                    [userLocation.lat, userLocation.lng],
                    [serverLocation.lat, serverLocation.lng]
                ]) : L.latLngBounds([
                    [userLocation.lat, userLocation.lng],
                    [serverLocation.lat, serverLocation.lng]
                ]);
                map.fitBounds(bounds, { padding: [80, 80] });

                // Calculate distance and latency
                const distanceToEdge = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    serverLocation.lat, serverLocation.lng
                );
                const distanceToCentral = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    centralizedLocation.lat, centralizedLocation.lng
                );

                const edgeLatency = estimateLatency(distanceToEdge);
                const centralLatency = estimateLatency(distanceToCentral);
                const improvement = (centralLatency / edgeLatency).toFixed(1);

                // Update UI
                document.getElementById('userLocationName').textContent = userLocation.name;
                document.getElementById('userLocationDetail').textContent =
                    `${userLocation.lat.toFixed(4)}°N, ${Math.abs(userLocation.lng).toFixed(4)}°W`;

                document.getElementById('distanceValue').textContent = `${Math.round(distanceToEdge)} miles`;
                document.getElementById('distanceDetail').textContent = `~${edgeLatency}ms estimated network latency`;

                document.getElementById('edgeLatency').textContent = `~${edgeLatency}ms`;
                document.getElementById('centralLatency').textContent = `~${centralLatency}ms`;
                document.getElementById('improvement').textContent = `${improvement}x faster`;

                // Update marker labels
                const markerUserName = document.getElementById('markerUserName');
                const markerUserLatency = document.getElementById('markerUserLatency');
                if (markerUserName) markerUserName.textContent = userLocation.name.split(',')[0];
                if (markerUserLatency) markerUserLatency.textContent = `${Math.round(distanceToEdge)} mi to edge`;
            }

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + '-tab').classList.add('active');

                    // Invalidate map size when switching to map tab
                    if (tab.dataset.tab === 'map' && map) {
                        setTimeout(() => map.invalidateSize(), 100);
                    }
                });
            });

            // Demo functionality (same as before)
            let isConnected = true;
            let autoQueryInterval = null;
            let queryHistory = [];
            let latencyData = { http: [], server: [], labels: [] };
            const MAX_DATA_POINTS = 60;

            const sampleTexts = [
                "The quick brown fox jumps over the lazy dog.",
                "Machine learning models can process natural language with remarkable accuracy.",
                "Kubernetes orchestrates containerized applications at scale across distributed infrastructure.",
                "GPU acceleration significantly improves deep learning inference performance.",
                "BERT is a transformer-based model designed for natural language understanding tasks.",
                "Distributed systems require careful consideration of network latency and fault tolerance.",
                "Edge computing brings computation closer to data sources for lower latency.",
                "Real-time inference requires optimized model serving infrastructure.",
                "Content delivery networks distribute data geographically for faster access.",
                "Mobile applications benefit from low-latency backend services."
            ];

            const ctx = document.getElementById('latencyChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'HTTP Latency',
                            data: [],
                            borderColor: '#58a6ff',
                            backgroundColor: 'rgba(88, 166, 255, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2
                        },
                        {
                            label: 'Server Latency',
                            data: [],
                            borderColor: '#a371f7',
                            backgroundColor: 'rgba(163, 113, 247, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#21262d',
                            titleColor: '#e6edf3',
                            bodyColor: '#8b949e',
                            borderColor: '#30363d',
                            borderWidth: 1,
                            callbacks: {
                                label: ctx => ctx.dataset.label + ': ' + ctx.raw.toFixed(2) + ' ms'
                            }
                        }
                    },
                    scales: {
                        x: { grid: { color: 'rgba(48, 54, 61, 0.5)' }, ticks: { color: '#8b949e', maxTicksLimit: 10 } },
                        y: { beginAtZero: true, grid: { color: 'rgba(48, 54, 61, 0.5)' }, ticks: { color: '#8b949e', callback: v => v + ' ms' } }
                    }
                }
            });

            function formatTime(date) {
                return date.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            }

            function updateConnectionStatus(status, message) {
                const el = document.getElementById('connectionStatus');
                el.className = `connection-status ${status}`;
                el.innerHTML = `<span class="status-indicator ${status === 'error' ? 'error' : ''}"></span> ${message}`;
                isConnected = status === 'connected';
            }

            function addToChart(httpLatency, serverLatency) {
                latencyData.labels.push(formatTime(new Date()));
                latencyData.http.push(httpLatency);
                latencyData.server.push(serverLatency);
                if (latencyData.labels.length > MAX_DATA_POINTS) {
                    latencyData.labels.shift();
                    latencyData.http.shift();
                    latencyData.server.shift();
                }
                chart.data.labels = latencyData.labels;
                chart.data.datasets[0].data = latencyData.http;
                chart.data.datasets[1].data = latencyData.server;
                chart.update('none');
            }

            function addToLog(text, httpLatency, serverLatency, success) {
                queryHistory.unshift({ time: new Date(), text, httpLatency, serverLatency, success });
                if (queryHistory.length > 100) queryHistory.pop();
                renderLog();
                updateStats();
            }

            function renderLog() {
                const el = document.getElementById('queryLog');
                if (!queryHistory.length) {
                    el.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">No queries yet.</div>';
                    return;
                }
                el.innerHTML = queryHistory.slice(0, 50).map(e => `
                    <div class="log-entry">
                        <div class="status-indicator ${e.success ? '' : 'error'}"></div>
                        <div class="log-text" title="${e.text}">${e.text}</div>
                        <div class="log-latency">
                            <span class="latency-badge http">${e.httpLatency.toFixed(1)} ms</span>
                            <span class="latency-badge server">${e.serverLatency.toFixed(1)} ms</span>
                        </div>
                        <div class="log-time">${formatTime(e.time)}</div>
                    </div>
                `).join('');
                document.getElementById('logCount').textContent = `${queryHistory.length} queries`;
            }

            function updateStats() {
                const successful = queryHistory.filter(q => q.success);
                document.getElementById('successCount').textContent = successful.length;
                document.getElementById('errorCount').textContent = queryHistory.length - successful.length;
                if (successful.length) {
                    document.getElementById('avgHttpLatency').textContent = (successful.reduce((s, q) => s + q.httpLatency, 0) / successful.length).toFixed(1) + ' ms';
                    document.getElementById('avgServerLatency').textContent = (successful.reduce((s, q) => s + q.serverLatency, 0) / successful.length).toFixed(1) + ' ms';
                }
                const recent = queryHistory.filter(q => q.time.getTime() > Date.now() - 10000);
                document.getElementById('rps').textContent = (recent.length / 10).toFixed(1);
            }

            async function sendQuery(text = null) {
                const queryText = text || sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
                const startTime = performance.now();
                try {
                    const response = await fetch('/v1/models/bert:predict', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ texts: [queryText] })
                    });
                    const httpLatency = performance.now() - startTime;
                    if (response.ok) {
                        const data = await response.json();
                        addToChart(httpLatency, data.latency_ms || 0);
                        addToLog(queryText, httpLatency, data.latency_ms || 0, true);
                        if (!isConnected) updateConnectionStatus('connected', 'Connected');
                    } else {
                        addToLog(queryText, httpLatency, 0, false);
                        updateConnectionStatus('disconnected', `Error: ${response.status}`);
                    }
                } catch (error) {
                    addToLog(queryText, performance.now() - startTime, 0, false);
                    updateConnectionStatus('disconnected', 'Connection Failed');
                }
            }

            document.getElementById('sendQuery').addEventListener('click', () => sendQuery());
            document.getElementById('clearStats').addEventListener('click', () => {
                queryHistory = [];
                latencyData = { http: [], server: [], labels: [] };
                chart.data.labels = [];
                chart.data.datasets[0].data = [];
                chart.data.datasets[1].data = [];
                chart.update();
                document.getElementById('avgHttpLatency').textContent = '--';
                document.getElementById('avgServerLatency').textContent = '--';
                document.getElementById('successCount').textContent = '0';
                document.getElementById('errorCount').textContent = '0';
                document.getElementById('rps').textContent = '0.0';
                renderLog();
            });

            document.getElementById('autoQuery').addEventListener('change', function() {
                if (this.checked) {
                    autoQueryInterval = setInterval(() => sendQuery(), parseInt(document.getElementById('interval').value) || 1000);
                } else {
                    clearInterval(autoQueryInterval);
                }
            });

            document.querySelectorAll('.sample-query').forEach(el => {
                el.addEventListener('click', () => sendQuery(el.dataset.text));
            });

            // Initialize
            initMap();
            fetch('/health').then(r => r.json()).then(d => {
                if (d.status === 'healthy') updateConnectionStatus('connected', 'Connected');
            }).catch(() => updateConnectionStatus('disconnected', 'Connection Failed'));
        </script>
    </body>
    </html>
